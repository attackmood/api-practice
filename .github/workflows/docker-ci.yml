name: ğŸš€ Deploy Spring Boot App

on:
  push:
    branches:
      - master  # âœ… master ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë˜ë©´ ì‹¤í–‰
permissions:
  contents: read
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ğŸ’» GitHub Actions ì‹¤í–‰ í™˜ê²½

    steps:
      # ğŸ“Œ 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
      # ğŸ“Œ 4ï¸âƒ£ JDK ë²„ì „ í™•ì¸
      - name: ğŸ§ Verify Java Version
        run: java -version

      # # ğŸ“Œ 2ï¸âƒ£ ê¸°ì¡´ JDK ì œê±°
      # - name: ğŸ—‘ï¸ Remove default JDK (if any)
      #   run: sudo apt-get remove -y java-common default-jdk

      # ğŸ“Œ 3ï¸âƒ£ JDK 17 ì„¤ì¹˜
      - name: âš™ï¸ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          check-latest: true


      # ğŸ“Œ 3ï¸âƒ£ Gradle ìºì‹± (ë¹Œë“œ ì†ë„ ìµœì í™”)
      - name: ğŸ’¾ Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

     # ğŸ“Œ 4ï¸âƒ£ í™˜ê²½ë³„ application.yml íŒŒì¼ ìƒì„±
      - name: ğŸ“ Generate application.yml files
        run: |
          # resources í´ë” ìƒì„±
          mkdir -p ./src/main/resources
          
          # ê¸°ë³¸ application.yml ìƒì„± (main, develop ê³µí†µ)
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "${{ secrets.YML }}" > ./src/main/resources/application.yml
          fi

          # ê°œë°œ í™˜ê²½ (develop ë¸Œëœì¹˜)
          if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "${{ secrets.YML_DEV }}" > ./src/main/resources/application-dev.yml
          fi

          # ìš´ì˜ í™˜ê²½ (main ë¸Œëœì¹˜)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "${{ secrets.YML_PROD }}" > ./src/main/resources/application-prod.yml
          fi
        shell: bash

      # ğŸ“Œ 5ï¸âƒ£ Gradle ë¹Œë“œ ì‹¤í–‰ (JAR ìƒì„±)
      - name: ğŸ—ï¸ Build with Gradle
        run: gradle clean bootJar --no-daemon

      # ğŸ“Œ 6ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ & Docker Hubì— í‘¸ì‹œ
      - name: ğŸ³ Build and Push Docker Image
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker build --build-arg JAR_FILE=build/libs/demo.jar -t ${{ secrets.DOCKER_USERNAME }}/my-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/my-app:latest

      # ğŸ“Œ 7ï¸âƒ£ ìµœì‹  Docker ì´ë¯¸ì§€ Pull & Spring Boot ì»¨í…Œì´ë„ˆ ì¬ë°°í¬
      - name: ğŸš€ Deploy to Local Server
        run: |
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          docker pull ${{ secrets.DOCKER_USERNAME }}/my-app:latest

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          docker stop springboot-app || true
          docker rm springboot-app || true

          # í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ì´ë¦„ í™•ì¸ (ì¶œë ¥ í›„ ë³€ìˆ˜ì— ì €ì¥)
          NETWORK_NAME=$(docker network ls --format '{{.Name}}' | grep my-network)
          echo "Detected network: $NETWORK_NAME"

          # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ìœ ì§€)
          docker run -d --name springboot-app \
            -p 8081:8080 \
            --network "$NETWORK_NAME" \
            --restart always \
            ${{ secrets.DOCKER_USERNAME }}/my-app:latest

          # ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì•ˆ ëœ ê²½ìš° ê°•ì œ ì—°ê²°
          docker network inspect "$NETWORK_NAME" | grep springboot-app || \
          docker network connect "$NETWORK_NAME" springboot-app

          # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì‚­ì œ (ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½)
          docker image prune -f



